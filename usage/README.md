
# PetShop API Sample

The goal is to make the codebase clearer for beginners by splitting the original monolithic file into logical modules, while preserving all the features and conventions demonstrated in the original sample.

This structure helps beginners understand how to build a Jetpath application by separating concerns into different files:

-   **Framework Initialization and Configuration:** How the app is set up.
-   **Global Middleware:** Logic applied to all requests (logging, error handling).
-   **Data Models and Storage:** Where data structures and in-memory data reside.
-   **API Routes:** Grouping related API endpoints together.
-   **Utilities/Miscellaneous Routes:** Other supporting endpoints.
-   **WebSockets:** Handling real-time communication.
-   **Plugins:** External functionalities integrated into the framework.

All features from the original `app.jet.ts` sample are included in this version, including:

-   Convention-over-configuration routing (using exported function names like `GET_pets`, `POST_auth_login`).
-   Global middleware (`MIDDLEWARE_`) for logging and error handling.
-   In-memory data storage (arrays of pet and review objects).
-   Authentication and Authorization checks (using a mock plugin).
-   Logging (using a mock plugin).
-   Input validation using `use().body()` (including objects, arrays, files).
-   Handling various HTTP methods (GET, POST, PUT, DELETE).
-   Dynamic routing with path parameters (e.g., `/petBy/:id`).
-   Query parameter parsing for filtering, sorting, and pagination.
-   **File uploads** (handling multipart/form-data).
-   **WebSocket communication** for real-time updates.
-   Automatic API Documentation UI (Swagger UI).
-   API Documentation Export (JSON, YAML, Markdown).
-   Error Handling and Testing routes (`/error`).
-   Health Check route (`/health`).
-   Serving static/uploaded files (`/serve/*`, `/static/*`).

## Code Structure

The original `app.jet.ts` file has been split into the following directories and files within the `src` folder:

```

petshop-api/
├── src/
│   ├── data/
│   │   └── models.ts         \# Defines data types and in-memory data arrays (pets, reviews).
│   ├── middleware/
│   │   └── global.ts       \# Contains the global middleware (MIDDLEWARE\_) for logging and error handling.
│   ├── plugins/            \# Directory for external plugins (mock examples)
│   │   ├── auth.ts         \# Mock authentication plugin (authenticate, verify, isAdmin).
│   │   └── logging.ts      \# Mock logging plugin (info, warn, error).
│   ├── routes/
│   │   ├── auth.ts         \# Authentication routes (e.g., POST /auth/login).
│   │   ├── live.ts         \# WebSocket route (GET /live) and broadcasting logic.
│   │   ├── pets.ts         \# Pet management routes (CRUD, search, image upload, gallery).
│   │   ├── reviews.ts      \# Review management routes (GET, POST, DELETE reviews for pets).
│   │   └── utils.ts        \# Utility and miscellaneous routes (/, /stats, /error, /health, /export/docs, /upload, /serve, /static).
│   ├── types.ts            \# Defines TypeScript types used across the application (PetType, ReviewType).
│   └── index.ts            \# Main application entry point: Jetpath app initialization, configuration, plugin registration, imports.
├── package.json              \# Project dependencies and scripts.
├── README.md                 \# This file.
└── pet-shop-api-log.log      \# Log file generated by the logger plugin (created on first run).
└── uploads/                  \# Directory for uploaded files (create this manually)
├── pet-images/           \# Directory for uploaded pet images (create this manually)
└── general-files/        \# Directory for general file uploads (create this manually)
└── served-content/           \# Directory for files served via /serve/\* (create this manually)
└── public/                   \# Directory for static files served via /static/\* (create this manually)
└── static/               \# Subdirectory for static files (create this manually)

````

## Explanation of the Structure

-   **`src/index.ts`**: This is the application's bootstrapper. It sets up the core Jetpath application instance with global configurations (`apiDoc`, `globalHeaders`, `port`, `upgrade`). It initializes the database (in this case, conceptually preparing the in-memory data). It registers external plugins using `app.addPlugin()`. Crucially, it **imports** the other route and middleware files. Jetpath then automatically discovers and registers the exported route handlers (like `GET_pets`, `POST_auth_login`) and global middleware (`MIDDLEWARE_`) based on their naming conventions in these imported files.
-   **`src/types.ts`**: Centralizes the TypeScript interface/type definitions (`PetType`, `ReviewType`), promoting code consistency and clarity.
-   **`src/data/models.ts`**: Holds the application's data structures (the `PetType` and `ReviewType` definitions again for clarity, although imported from `types.ts`) and the in-memory data arrays (`pets`, `reviews`). In a real-world application, this layer would contain database connection logic and functions to interact with the database, abstracting data access away from the route handlers.
-   **`src/middleware/global.ts`**: Contains the single exported `MIDDLEWARE_` function. This function defines logic that runs for **every** incoming request (the pre-handler) and after the request is processed (the post-handler), handling cross-cutting concerns like logging, authentication checks, and error handling as demonstrated in the original sample. Jetpath automatically applies this global middleware due to its name.
-   **`src/plugins/`**: This directory represents external plugins. The original sample referenced `auth.ts` and `logging.ts`. These are included here as mock examples showing the expected structure (exporting plugin instances with specific methods like `authenticateUser`, `info`, `error`) that Jetpath's `app.addPlugin()` expects. The actual implementation details of these plugins would be more complex.
-   **`src/routes/`**: This directory contains files that group API endpoint handlers by functionality (auth, pets, reviews, live, utils). Each file exports functions following Jetpath's `METHOD_path$param` naming convention (e.g., `GET_pets`, `POST_auth_login`, `PUT_petBy$id`, `GET_live`).
    -   `use(functionName).body(...)` is chained directly after the function definition to specify input validation for the request body.
    -   `use(functionName).info(...)` is chained (often after `use().body()`) to provide documentation details for that specific endpoint, which Jetpath uses to generate the API documentation UI and export.
    -   Route handlers access the request context (`ctx`) to get parameters, body, plugins, state, and send responses. They interact with the data layer (`../../data/models`).
-   **File System Directories**: `uploads/pet-images`, `uploads/general-files`, `served-content`, and `public/static` are directories used by the file upload and serving routes. You need to create these manually for those features to work correctly.

This structure is designed to be easier for a beginner to navigate, understand the separation of concerns, and see how different parts of a Jetpath application fit together while still preserving the framework's unique conventions.

## Prerequisites

* **Node.js** (v18 or higher recommended) or **Bun** (v1.0 or higher recommended). Ensure your chosen runtime is installed and accessible from your terminal.
* A basic understanding of JavaScript or TypeScript.
* Familiarity with fundamental backend and RESTful API concepts.
* The **Jetpath framework** source code or package installed/accessible. You **must** update the `jetpath` dependency path in `package.json` to point to the correct location or package name of the Jetpath framework.

## Setup

1.  **Obtain the Code:** Create the directory structure (`src`, `src/data`, `src/middleware`, `src/plugins`, `src/routes`, `src/routes/data`, `src/routes/middleware`, `src/routes/plugins`, `src/routes/routes`, `src/routes/types`) and files listed above, or clone the repository if this code is hosted in a Git repository:
    ```bash
    # If cloning from a repo
    git clone <repository_url>
    cd petshop-api
    ```
    *(Replace `<repository_url>` with the actual URL if applicable)*

2.  **Create Necessary Directories:** Manually create the file system directories used by the file handling routes:
    ```bash
    mkdir -p uploads/pet-images
    mkdir -p uploads/general-files
    mkdir -p served-content
    mkdir -p public/static
    ```

3.  **Update the `jetpath` dependency:**
    Open the `package.json` file and change the line `"jetpath": "file:../path/to/your/jetpath/dist"` to the correct path relative to your project's root directory where the Jetpath framework's `dist` directory is located, or replace it with the package name if Jetpath is published to an npm registry.

4.  **Install dependencies:**
    Open your terminal in the project's root directory and run the appropriate command for your chosen runtime:

    * **If you will primarily use Node.js:**
        ```bash
        npm install
        ```
        This will install `better-sqlite3` (if needed for SQLite, although this sample uses in-memory arrays), `ts-node` (which allows Node.js to run TypeScript files directly), and `typescript`, plus any other dependencies defined in `package.json` (like placeholders for plugins).

    * **If you will primarily use Bun:**
        ```bash
        bun install
        ```
        Bun will handle the dependencies listed in `package.json`. Bun runs TypeScript files directly, so `ts-node` is not needed.

## Running the API

You can run the API using either Node.js or Bun. The in-memory data will reset each time the server restarts.

* **Using Node.js:**
    ```bash
    npm run start:node
    ```
    This script uses `ts-node` to execute the `src/index.ts` file with Node.js.

* **Using Bun:**
    ```bash
    bun run src/index.ts
    # Alternatively, use the npm script alias:
    bun run start:bun
    ```
    Bun runs the `src/index.ts` file directly, using its native TypeScript capabilities.

Once running, the server will print messages to the console indicating which port it's listening on (defaulting to 9000, as in the original sample) and the URL where you can access the API documentation.

## API Documentation (Swagger UI)

An interactive API documentation interface (Swagger UI) is automatically generated and available while the server is running. Open your web browser and go to:

`http://localhost:9000/api-doc`

*(Note the port 9000 as configured in `src/index.ts`)*. This documentation is created by Jetpath based on the `apiDoc` configuration in `src/index.ts` and the `.info` properties you've added to the route handlers. It provides a convenient way to explore the API's endpoints and their expected parameters and responses. The documentation itself is secured with basic auth (admin/1234) as in the original sample.

## Example API Calls and Features

You can interact with the API using command-line tools like `curl` or graphical clients like Postman or Insomnia. Since the original sample used in-memory data and mock plugins, you'll need to authenticate first to access protected routes (admin/1234).

**1. Get API Status (GET /):**

```bash
curl http://localhost:9000/
````

*Expect basic API information.*

**2. Authenticate (POST /auth/login):**

```bash
curl -X POST http://localhost:9000/auth/login \
-H "Content-Type: application/json" \
-d '{"username": "admin", "password": "1234"}'
```

*Expect a token in the response. You will need this token in the `Authorization: Bearer <token>` header for protected routes.*

**3. Get all pets (GET /pets):**

```bash
curl http://localhost:9000/pets
# With pagination/filtering example:
# curl "http://localhost:9000/pets?limit=5&species=dog&search=friendly"
```

*Expect a list of pets.*

**4. Add a new pet (POST /pets - requires Authentication and Admin role):**

```bash
curl -X POST http://localhost:9000/pets \
-H "Content-Type: application/json" \
-H "Authorization: Bearer <your_token_here>" \
-d '{
  "name": "Buddy",
  "species": "Dog",
  "breed": "Beagle",
  "age": 2,
  "gender": "Male",
  "color": "Brown and White",
  "description": "Energetic and playful Beagle",
  "price": 300,
  "available": true,
  "tags": ["playful", "loyal"]
}'
```

*Replace `<your_token_here>` with the token from the login response.*

**5. Upload a pet image (POST /petImage/:id - requires Authentication and Admin role):**

```bash
curl -X POST http://localhost:9000/petImage/pet-1 \
-H "Authorization: Bearer <your_token_here>" \
-F "image=@/path/to/your/image.jpg" \
-H "Content-Type: multipart/form-data"
```

*Replace `pet-1` with a pet ID and `/path/to/your/image.jpg` with an image file path.*

**6. Connect to WebSocket for live updates (GET /live):**

Use a WebSocket client to connect to `ws://localhost:9000/live`. You should receive messages for certain events (like pet additions, though this might require adding broadcast calls in the route handlers).

**7. Export API Documentation (GET /export/docs/:format):**

```bash
curl http://localhost:9000/export/docs/json
# or yaml, or markdown
```

By exploring these modular files, you should gain a clearer understanding of how the different features of Jetpath demonstrated in the original sample can be organized into a more maintainable structure.

## Mock Plugins

The sample relies on `authPlugin` and `jetLogger`. Simple mock versions are provided in `src/plugins/` to allow the code to run. In a real application, you would use actual plugin implementations.
