import{opendir as b}from"node:fs/promises";import{createServer as O}from"node:http";function _(s){let e={allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],origin:"*",secureContext:!1,keepHeadersOnError:!1,allowHeaders:[]};for(let o in s)s.hasOwnProperty(o)&&(e[o]=s[o]);return Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.keepHeadersOnError=e.keepHeadersOnError===void 0||!!e.keepHeadersOnError,function(t){let n=e.credentials,r={};function i(p,l){t.set(p,l),r[p]=l}if(t.method!=="OPTIONS")i("Access-Control-Allow-Origin",e.origin),i("Vary","Origin"),n===!0&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&t.set("Access-Control-Allow-Headers",e.allowHeaders.join(","));else{if(!t.get("Access-Control-Request-Method"))return;t.set("Access-Control-Allow-Origin",e.origin),n===!0&&t.set("Access-Control-Allow-Credentials","true"),e.maxAge&&t.set("Access-Control-Max-Age",e.maxAge),e.privateNetworkAccess&&t.get("Access-Control-Request-Private-Network")&&t.set("Access-Control-Allow-Private-Network","true"),e.allowMethods&&t.set("Access-Control-Allow-Methods",e.allowMethods.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&t.set("Access-Control-Allow-Headers",e.allowHeaders.join(",")),t.statusCode=204}}}import{URLSearchParams as k}from"node:url";import C from"node:path";import{cwd as T}from"node:process";var a={avoidErr(s){try{return s(),!0}catch{return!1}},getRutime(){let s=a.avoidErr(()=>Bun),e=a.avoidErr(()=>Deno);this.runtime={bun:s,deno:e,node:!s&&!e}},runtime:null,decorators:{},server(){if(a.runtime.node)return O((s,e)=>{w(s,e)});if(a.runtime.deno)return{listen(s){Deno.serve({port:s},w)}};if(a.runtime.bun)return{listen(s){Bun.serve({port:s,fetch:w})}}}};a.getRutime();var f={GET:{},POST:{},HEAD:{},PUT:{},PATCH:{},DELETE:{},OPTIONS:{}},d={PRE:!1,POST:!1,ERROR:!1},h=class extends Error{constructor(e="done"){super(e)}},y=new h,c={cors:void 0,set(s,e){if(s==="cors"&&e){if(this.cors=_({exposeHeaders:"",allowMethods:"",allowHeaders:"",maxAge:"",keepHeadersOnError:!0,secureContext:!1,privateNetworkAccess:void 0,...typeof e=="object"?e:{}}),Array.isArray(e.allowMethods)){f={};for(let o of e.allowMethods)f[o.toUpperCase()]={}}return}this[s]=e}},A=(s,e={})=>({...e,request:s,body:null,app:{},statusCode:200,method:s.method,reply(o){let t;switch(typeof o){case"string":t="text/plain",this._1=o;break;case"object":t="application/json",this._1=JSON.stringify(o);break;default:t="text/plain",this._1=String(o);break}throw this._2["Content-Type"]=t,this._4=!0,y},redirect(o){throw this.statusCode=301,this._2.Location=o,this._1=void 0,this._4=!0,y},throw(o=404,t="Not Found"){if(!this._4)switch(this.statusCode=400,typeof o){case"number":this.statusCode=o,typeof t=="object"?(this._2["Content-Type"]="application/json",this._1=JSON.stringify(t)):typeof t=="string"&&(this._2["Content-Type"]="text/plain",this._1=t);break;case"string":this._2["Content-Type"]="text/plain",this._1=o;break;case"object":this._2["Content-Type"]="application/json",this._1=String(o);break}throw this._4=!0,y},get(o){if(o)return this.request.headers[o]},set(o,t){o&&t&&(this._2[o]=t)},pass(o,t){o&&t&&(this.app[o]=t)},pipe(o,t){this._2["Content-Disposition"]=t,this._3=o,this._4=!0},json(){return this.body?this.body:a.runtime.node?new Promise(o=>{let t="";this.request.on("data",n=>{t+=n.toString()}),this.request.on("end",()=>{try{this.body=JSON.parse(t)}catch{}o(this.body)})}):this.request.json()},text(){return this.body?this.body:a.runtime.node?new Promise(o=>{let t="";this.request.on("data",n=>{t+=n.toString()}),this.request.on("end",()=>{this.body=t,o(t)})}):this.request.text()},_1:void 0,_2:{},_3:void 0,_4:!1,params:{},search:{}}),u=(s,e)=>{if(!a.runtime.node)return e?.statusCode===301&&e._2.Location?Response.redirect(e._2.Location):new Response(e?._1||"Not found!",{status:e?.statusCode||404,headers:e?._2||{}});s.writeHead(e?.statusCode||404,e?._2||{"Content-Type":"text/plain"}),s.end(e?._1||"Not found!")},w=async(s,e)=>{let o={},t={},n=E(s.method,s.url);if(n){let r=A(s,a.decorators);n.length>1&&([n,o,t]=n,r.params=o,r.search=t);try{return d.PRE&&await d.PRE?.(r),await n(r),d.POST&&await d.POST(r),c.cors&&c.cors(r),!r._1&&r._3&&r._3.pipe(e),u(e,r)}catch(i){if(i instanceof h)return c.cors&&c.cors(r),u(e,r);try{return d.ERROR&&await d.ERROR(r,i),c.cors&&c.cors(r),u(e,r)}catch{return c.cors&&c.cors(r),u(e,r)}}}else{if(c.cors||s.method==="OPTIONS"){let r=A(s);return c.cors(r),u(e,r)}return u(e)}},R=s=>{if(s.includes("hook__"))return s.split("hook__")[1];s=s.split("_");let e=s.shift();if(s="/"+s.join("/"),s=s.split("$$"),s=s.join("/?"),s=s.split("$"),s=s.join("/:"),/(GET|POST|PUT|PATCH|DELETE|OPTIONS)/.test(e))return[e,s]};async function m(s,e){s=s||T(),s=C.resolve(T(),s),e&&console.log("JetPath: "+s);let o=await b(s);for await(let t of o){if(t.isFile()&&t.name.endsWith(".js")){let n=await import(C.resolve(s+"/"+t.name));for(let r in n){let i=R(r);if(i){if(typeof i!="string"&&f[i[0]])f[i[0]][i[1]]=n[r];else if(d[i]===!1)d[i]=n[r];else if(i==="DECORATOR"){let p=n[r]();a.decorators=Object.assign(a.decorators,p)}}}}t.isDirectory()&&t.name!=="node_modules"&&t.name!==".git"&&await m(s+"/"+t.name,e)}}var E=(s,e)=>{let o=f[s];if(e[0]!=="/"&&(e=e.slice(e.indexOf("/",7))),o[e])return o[e];if(typeof o=="function"){o();return}if(o[e+"/"])return o[e];if(e.includes("/?")){let t=[...new k(e).entries()],n={};for(let r in t)n[t[r][0].includes("?")?t[r][0].split("?")[1]:t[r][0]]=t[r][1];return[o[e.split("/?")[0]+"/?"],,n]}for(let t in o){if(!t.includes(":"))continue;let n=e.split("/"),r=t.split("/");e.endsWith("/")&&n.pop();let i=0,p=0;if(r.length===n.length){for(let l=0;l<r.length;l++){if(r[l].includes(":")){p++;continue}n[l]===r[l]&&i++}if(i+p===r.length){let l={};for(let g=0;g<r.length;g++)r[g].includes(":")&&(l[r[g].split(":")[1]]=n[g]);return[o[t],l]}}}};var P=class{constructor(e){this.options=e||{printRoutes:!0},this.server=a.server()}async listen(){let e=this.options?.port||8080;for(let[o,t]of Object.entries(this.options||{}))c.set(o,t);if(c.printRoutes){console.log("JetPath: compiling paths..."),await m(this.options?.source,!0),console.log("JetPath: done."),console.log(d);for(let o in f){let t=f[o];if(t&&Object.keys(t).length){console.log(`
`+o+": routes");for(let n in t)console.log("'"+n+"'")}}}else await m(this.options?.source,!1);console.log(`
JetPath app listening on port ${e}...`),this.server.listen(this.options?.port||8080)}};export{P as JetPath};
