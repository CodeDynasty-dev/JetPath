import { opendir } from 'node:fs/promises';
import { createServer } from 'node:http';
import { fileURLToPath, URLSearchParams } from 'node:url';
import P, { dirname } from 'node:path';
import { cwd } from 'node:process';

function h(t){let e={allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],origin:"*",secureContext:!1,keepHeadersOnError:!1,allowHeaders:["X-E"]};for(let r in t)t[r]&&(e[r]=t[r]);return Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.keepHeadersOnError=e.keepHeadersOnError===void 0||!!e.keepHeadersOnError,async function(s){let i=e.credentials;function n(c,a){s.set(c,a);}if(s.method!=="OPTIONS")n("Access-Control-Allow-Origin",e.origin),i===!0&&n("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&n("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),e.secureContext&&(n("Cross-Origin-Opener-Policy","same-origin"),n("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&s.set("Access-Control-Allow-Headers",e.allowHeaders.join(","));else {if(!s.get("Access-Control-Request-Method"))return;s.set("Access-Control-Allow-Origin",e.origin),i===!0&&s.set("Access-Control-Allow-Credentials","true"),e.maxAge&&s.set("Access-Control-Max-Age",e.maxAge),e.privateNetworkAccess&&s.get("Access-Control-Request-Private-Network")&&s.set("Access-Control-Allow-Private-Network","true"),e.allowMethods&&s.set("Access-Control-Allow-Methods",e.allowMethods.join(",")),e.secureContext&&(n("Cross-Origin-Opener-Policy","same-origin"),n("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&s.set("Access-Control-Allow-Headers",e.allowHeaders.join(",")),s.code(204);}}}dirname(fileURLToPath(import.meta.url));var m=class t extends Error{constructor(...e){let r=t.geterr(e);super(r);}static geterr(e){return String(e.join(""))}},d={GET:{},POST:{},HEAD:{},PUT:{},PATCH:{},DELETE:{},OPTIONS:void 0},l={PRE:!0,POST:!0,ERROR:!0},f={cors:void 0,set(t,e){if(t==="cors"&&e){if(this.cors=h({exposeHeaders:"",allowMethods:"",allowHeaders:"",maxAge:"",keepHeadersOnError:void 0,origin:function(r){throw new Error("Function not implemented.")},credentials:function(r){throw new Error("Function not implemented.")},secureContext:!1,privateNetworkAccess:void 0,...typeof e=="object"?e:{}}),Array.isArray(e.allowMethods)){d={};for(let r of e.allowMethods)d[r.toUpperCase()]={};}return}this[t]=e;}};function x(t,e){let r,s=200;return {request:t,reply(o){try{switch(typeof o){case"string":e.writeHead(s,{"Content-Type":"text/plain"}),r=o;break;case"object":e.writeHead(s,{"Content-Type":"application/json"}),r=JSON.stringify(o);break;default:e.writeHead(s,{"Content-Type":"text/plain"}),r=o;break}}catch(n){console.error(n);}},throw(o,n){e.writeHead(o,{"Content-Type":"text/plain"}),e.end(n);},code(o){return o&&(s=o),s},method:t.method,get(o){if(o)return console.log({get_:t.headers}),t.headers[o]},set(o,n){o&&n&&(t.headers[o]=n);},pipe(o,n){e.setHeader("Content-Disposition",n),o.pipe(e);},json(){return new Promise(o=>{let n="";t.on("data",c=>{n+=c.toString();}),t.on("end",()=>{o(JSON.parse(n||"{}"));});})},text(){return new Promise(o=>{let n="";t.on("data",c=>{n+=c.toString();}),t.on("end",()=>{o(n);});})},_(){return r},params:void 0,search:void 0}}var p=createServer(async(t,e)=>{let r={},s={},i=k(t.method,t.url),o=x(t,e);if(i){i.length>1&&([i,r,s]=i,o.params=r,o.search=s);try{l.PRE?.(o),await i(o);let n=o._();l.POST&&(n=l.POST(o,n)),f.cors&&f.cors(o),console.log(n),e.end(n);}catch(n){l.ERROR?.(o,n);}}else e.writeHead(404,{"Content-Type":"text/plain"}),e.end("Not found!");}),O=t=>{if(t.includes("hook__"))return t.split("hook__")[1];t=t.split("_");let e=t.shift();if(t="/"+t.join("/"),t=t.split("$$"),t=t.join("/?"),t=t.split("$"),t=t.join("/:"),/(GET|POST|PUT|PATCH|DELETE|OPTIONS)/.test(e))return [e,t]};async function u(t){t=t||cwd().split("/").pop();let e=await opendir(t);for await(let r of e){if(r.isFile()&&r.name.endsWith(".js")){let s=await import(P.resolve(t+"/"+r.name));for(let i in s){let o=O(i);o&&(typeof o!="string"&&d[o[0]]?d[o[0]][o[1]]=s[i]:l[o]&&(l[o]=s[i]));}}r.isDirectory()&&r.name!=="node_modules"&&r.name!==".git"&&await u(t+"/"+r.name);}}var k=(t,e)=>{let r=d[t];if(r[e])return r[e];if(typeof r=="function"){r();return}if(r[e+"/"])return r[e];if(e.includes("/?")){let s=[...new URLSearchParams(e).entries()],i={};for(let o in s)i[s[o][0].includes("?")?s[o][0].split("?")[1]:s[o][0]]=s[o][1];return [r[e.split("/?")[0]+"/?"],,i]}for(let s in r){if(!s.includes(":"))continue;let i=e.split("/"),o=s.split("/");e.endsWith("/")&&i.pop();let n=0,c=0;if(o.length===i.length){for(let a=0;a<o.length;a++){if(o[a].includes(":")){c++;continue}i[a]===o[a]&&n++;}if(n+c===o.length){let a={};for(let g=0;g<o.length;g++)o[g].includes(":")&&(a[o[g].split(":")[1]]=i[g]);return [r[s],a]}}}};var y=class{constructor(e){this.options=e,this.server=p;}async listen(){let e=this.options?.port||8080;for(let[r,s]of Object.entries(this.options||{}))f.set(r,s);console.log("JetPath: compiling paths ... "),await u(this.options?.source),console.log("JetPath: done."),f.printRoutes&&(console.log(d),console.log(l)),console.log(`JetPath app listening on port ${e}`),p.on("error",r=>{r.code==="EADDRINUSE"&&(console.log("Address in use, retrying..."),setTimeout(()=>{p.close(),p.listen(e);},1e3));}),p.listen(this.options?.port||8080);}};

export { m as JetPathError, y as default };
