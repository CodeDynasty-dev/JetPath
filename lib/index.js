import { opendir } from 'node:fs/promises';
import { createServer } from 'node:http';
import { URLSearchParams } from 'node:url';
import H from 'node:path';
import { cwd } from 'node:process';

function _(t){let e={allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],origin:"*",secureContext:!1,keepHeadersOnError:!1,allowHeaders:[]};for(let o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);return Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.keepHeadersOnError=e.keepHeadersOnError===void 0||!!e.keepHeadersOnError,function(s){let n=e.credentials;function i(p,a){s.set(p,a);}if(s.method!=="OPTIONS")i("Access-Control-Allow-Origin",e.origin),i("Vary","Origin"),n===!0&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&s.set("Access-Control-Allow-Headers",e.allowHeaders.join(","));else {if(!s.get("Access-Control-Request-Method"))return;s.set("Access-Control-Allow-Origin",e.origin),n===!0&&s.set("Access-Control-Allow-Credentials","true"),e.maxAge&&s.set("Access-Control-Max-Age",e.maxAge),e.privateNetworkAccess&&s.get("Access-Control-Request-Private-Network")&&s.set("Access-Control-Allow-Private-Network","true"),e.allowMethods&&s.set("Access-Control-Allow-Methods",e.allowMethods.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&s.set("Access-Control-Allow-Headers",e.allowHeaders.join(",")),s.code(204);}}}var C=t=>{try{return t(),!0}catch{return !1}},E=()=>{let t=C(()=>Bun),e=C(()=>Deno);return {bun:t,deno:e,node:!t&&!e}},h=E(),f={listen(t){}};h.node&&(f=createServer((t,e)=>{w(t,e);}));h.deno&&(f={listen(t){Deno.serve({port:t},w);}});h.bun&&(f={listen(t){Bun.serve({port:t,fetch:w});}});var d={GET:{},POST:{},HEAD:{},PUT:{},PATCH:{},DELETE:{},OPTIONS:void 0},c={PRE:!0,POST:!0,ERROR:!0},y=new Error("done"),l={cors:void 0,set(t,e){if(t==="cors"&&e){if(this.cors=_({exposeHeaders:"",allowMethods:"",allowHeaders:"",maxAge:"",keepHeadersOnError:!0,secureContext:!1,privateNetworkAccess:void 0,...typeof e=="object"?e:{}}),Array.isArray(e.allowMethods)){d={};for(let o of e.allowMethods)d[o.toUpperCase()]={};}return}this[t]=e;}};function R(t){return {request:t,body:null,statusCode:200,method:t.method,reply(e,o="text/plain"){switch(typeof e){case"string":o="text/plain",this._1=e;break;case"object":e===null?(o="text/plain",this._1="null"):Array.isArray(e)?(o="application/json",this._1=JSON.stringify(e)):(o="application/json",this._1=JSON.stringify(e));break;default:o="text/plain",this._1=String(e);break}throw this._2["Content-Type"]=o,y},redirect(e){throw this.statusCode=301,this._2.Location=e,this._1=void 0,y},throw(e=404,o="Not Found"){throw this._2["Content-Type"]="text/plain",typeof e=="string"&&(o=e,e=400),this.statusCode=e,this._1=String(o),y},code(e){return e&&(this.statusCode=e),this.statusCode||200},get(e){if(e)return t.headers[e]},set(e,o){e&&o&&(this._2[e]=o);},pipe(e,o){this._2["Content-Disposition"]=o,this._3=e;},json(){return new Promise(e=>{let o="";t.on("data",s=>{o+=s.toString();}),t.on("end",()=>{let s=JSON.parse(o||"{}");this.body=s,e(s);});})},text(){return new Promise(e=>{let o="";t.on("data",s=>{o+=s.toString();}),t.on("end",()=>{e(o);});})},_1:void 0,_2:{},_3:void 0,params:{},search:{}}}var u=(t=void 0,e)=>{if(!h.node){let o={};for(let s in t?._2)Object.prototype.hasOwnProperty.call(t._2,s)&&(o[s]=t._2[s]);return new Response(t?._1||"Not found!",{status:t?.code()||404,headers:o})}e.writeHead(t?.code()||404,t?._2||{"Content-Type":"text/plain"}),e.end(t?._1||"Not found!");},w=async(t,e)=>{let o={},s={},n=S(t.method,t.url);if(n){let r=R(t);n.length>1&&([n,o,s]=n,r.params=o,r.search=s);try{return await c.PRE?.(r),await n(r),c.POST&&await c.POST(r),l.cors&&l.cors(r),!r._1&&r._3&&r._3.pipe(e),u(r,e)}catch(i){if(String(i).includes("done"))return l.cors&&l.cors(r),u(r,e);try{return await c.ERROR?.(r,i),l.cors&&l.cors(r),u(r,e)}catch{return l.cors&&l.cors(r),u(r,e)}}}else return u(void 0,e)},x=t=>{if(t.includes("hook__"))return t.split("hook__")[1];t=t.split("_");let e=t.shift();if(t="/"+t.join("/"),t=t.split("$$"),t=t.join("/?"),t=t.split("$"),t=t.join("/:"),/(GET|POST|PUT|PATCH|DELETE|OPTIONS)/.test(e))return [e,t]};async function m(t){t=t||cwd().split("/").pop();let e=await opendir(t);for await(let o of e){if(o.isFile()&&o.name.endsWith(".js")){let s=await import(H.resolve(t+"/"+o.name));for(let n in s){let r=x(n);r&&(typeof r!="string"&&d[r[0]]?d[r[0]][r[1]]=s[n]:c[r]&&(c[r]=s[n]));}}o.isDirectory()&&o.name!=="node_modules"&&o.name!==".git"&&await m(t+"/"+o.name);}}var S=(t,e)=>{let o=d[t];if(e[0]!=="/"&&(e=e.slice(e.indexOf("/",7))),o[e])return o[e];if(typeof o=="function"){o();return}if(o[e+"/"])return o[e];if(e.includes("/?")){let s=[...new URLSearchParams(e).entries()],n={};for(let r in s)n[s[r][0].includes("?")?s[r][0].split("?")[1]:s[r][0]]=s[r][1];return [o[e.split("/?")[0]+"/?"],,n]}for(let s in o){if(!s.includes(":"))continue;let n=e.split("/"),r=s.split("/");e.endsWith("/")&&n.pop();let i=0,p=0;if(r.length===n.length){for(let a=0;a<r.length;a++){if(r[a].includes(":")){p++;continue}n[a]===r[a]&&i++;}if(i+p===r.length){let a={};for(let g=0;g<r.length;g++)r[g].includes(":")&&(a[r[g].split(":")[1]]=n[g]);return [o[s],a]}}}};var A=class{constructor(e){this.options=e,this.server=f;}async listen(){let e=this.options?.port||8080;for(let[o,s]of Object.entries(this.options||{}))l.set(o,s);l.printRoutes?(console.log("JetPath: compiling paths ... "),await m(this.options?.source),console.log("JetPath: done."),console.log(c),console.log(d)):await m(this.options?.source),console.log(`JetPath app listening on port ${e}`),f.listen(this.options?.port||8080);}};

export { A as default };
