import{opendir as k}from"node:fs/promises";import{createServer as O}from"node:http";function A(t){let e={allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],origin:"*",secureContext:!1,keepHeadersOnError:!1,allowHeaders:[]};for(let o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);return Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.keepHeadersOnError=e.keepHeadersOnError===void 0||!!e.keepHeadersOnError,function(s){let r=e.credentials,n={};function i(p,a){s.set(p,a),n[p]=a}if(s.method!=="OPTIONS")i("Access-Control-Allow-Origin",e.origin),i("Vary","Origin"),r===!0&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&s.set("Access-Control-Allow-Headers",e.allowHeaders.join(","));else{if(!s.get("Access-Control-Request-Method"))return;s.set("Access-Control-Allow-Origin",e.origin),r===!0&&s.set("Access-Control-Allow-Credentials","true"),e.maxAge&&s.set("Access-Control-Max-Age",e.maxAge),e.privateNetworkAccess&&s.get("Access-Control-Request-Private-Network")&&s.set("Access-Control-Allow-Private-Network","true"),e.allowMethods&&s.set("Access-Control-Allow-Methods",e.allowMethods.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&s.set("Access-Control-Allow-Headers",e.allowHeaders.join(",")),s.statusCode=204}}}import{URLSearchParams as H}from"node:url";import C from"node:path";import{cwd as P}from"node:process";var T=t=>{try{return t(),!0}catch{return!1}},R=()=>{let t=T(()=>Bun),e=T(()=>Deno);return{bun:t,deno:e,node:!t&&!e}},h=R(),f={listen(t){}};h.node&&(f=O((t,e)=>{w(t,e)}));h.deno&&(f={listen(t){Deno.serve({port:t},w)}});h.bun&&(f={listen(t){Bun.serve({port:t,fetch:w})}});var l={GET:{},POST:{},HEAD:{},PUT:{},PATCH:{},DELETE:{},OPTIONS:{}},d={PRE:!0,POST:!0,ERROR:!0},y=new Error("done"),c={cors:void 0,set(t,e){if(t==="cors"&&e){if(this.cors=A({exposeHeaders:"",allowMethods:"",allowHeaders:"",maxAge:"",keepHeadersOnError:!0,secureContext:!1,privateNetworkAccess:void 0,...typeof e=="object"?e:{}}),Array.isArray(e.allowMethods)){l={};for(let o of e.allowMethods)l[o.toUpperCase()]={}}return}this[t]=e}},E=t=>({request:t,body:null,app:{},statusCode:200,method:t.method,reply(e,o="text/plain"){switch(typeof e){case"string":o="text/plain",this._1=e;break;case"object":o="application/json",this._1=JSON.stringify(e);break;default:o="text/plain",this._1=String(e);break}throw this._2["Content-Type"]=o,y},redirect(e){throw this.statusCode=301,this._2.Location=e,this._1=void 0,y},throw(e=404,o="Not Found"){switch(typeof e){case"string":this._2["Content-Type"]="text/plain",this._1=String(e);break;case"object":this._2["Content-Type"]="application/json",this._1=JSON.stringify(o);break;default:this._2["Content-Type"]="text/plain",this._1=String(e);break}throw y},get(e){if(e)return t.headers[e]},set(e,o){e&&o&&(this._2[e]=o)},pass(e,o){e&&o&&(this.app[e]=o)},pipe(e,o){this._2["Content-Disposition"]=o,this._3=e},json(){return new Promise(e=>{let o="";t.on("data",s=>{o+=s.toString()}),t.on("end",()=>{let s=JSON.parse(o||"{}");this.body=s,e(s)})})},text(){return new Promise(e=>{let o="";t.on("data",s=>{o+=s.toString()}),t.on("end",()=>{e(o)})})},_1:void 0,_2:{},_3:void 0,params:{},search:{}}),u=(t=void 0,e)=>{if(!h.node)return t?.statusCode===301&&t._2.Location?Response.redirect(t._2.Location):new Response(t?._1||"Not found!",{status:t?.statusCode||404,headers:t?._2||{}});e.writeHead(t?.statusCode||404,t?._2||{"Content-Type":"text/plain"}),e.end(t?._1||"Not found!")},w=async(t,e)=>{let o={},s={},r=S(t.method,t.url);if(r){let n=E(t);r.length>1&&([r,o,s]=r,n.params=o,n.search=s);try{return await d.PRE?.(n),await r(n),d.POST&&await d.POST(n),c.cors&&c.cors(n),!n._1&&n._3&&n._3.pipe(e),u(n,e)}catch(i){if(String(i).includes("done"))return c.cors&&c.cors(n),u(n,e);try{return await d.ERROR?.(n,i),c.cors&&c.cors(n),u(n,e)}catch{return c.cors&&c.cors(n),u(n,e)}}}else return u(void 0,e)},b=t=>{if(t.includes("hook__"))return t.split("hook__")[1];t=t.split("_");let e=t.shift();if(t="/"+t.join("/"),t=t.split("$$"),t=t.join("/?"),t=t.split("$"),t=t.join("/:"),/(GET|POST|PUT|PATCH|DELETE|OPTIONS)/.test(e))return[e,t]};async function m(t){t=t||P(),t=C.resolve(P(),t),console.log("JetPath: "+t);let e=await k(t);for await(let o of e){if(o.isFile()&&o.name.endsWith(".js")){let s=await import(C.resolve(t+"/"+o.name));for(let r in s){let n=b(r);n&&(typeof n!="string"&&l[n[0]]?l[n[0]][n[1]]=s[r]:d[n]&&(d[n]=s[r]))}}o.isDirectory()&&o.name!=="node_modules"&&o.name!==".git"&&await m(t+"/"+o.name)}}var S=(t,e)=>{let o=l[t];if(e[0]!=="/"&&(e=e.slice(e.indexOf("/",7))),o[e])return o[e];if(typeof o=="function"){o();return}if(o[e+"/"])return o[e];if(e.includes("/?")){let s=[...new H(e).entries()],r={};for(let n in s)r[s[n][0].includes("?")?s[n][0].split("?")[1]:s[n][0]]=s[n][1];return[o[e.split("/?")[0]+"/?"],,r]}for(let s in o){if(!s.includes(":"))continue;let r=e.split("/"),n=s.split("/");e.endsWith("/")&&r.pop();let i=0,p=0;if(n.length===r.length){for(let a=0;a<n.length;a++){if(n[a].includes(":")){p++;continue}r[a]===n[a]&&i++}if(i+p===n.length){let a={};for(let g=0;g<n.length;g++)n[g].includes(":")&&(a[n[g].split(":")[1]]=r[g]);return[o[s],a]}}}};var _=class{constructor(e){this.options=e||{printRoutes:!0},this.server=f}async listen(){let e=this.options?.port||8080;for(let[o,s]of Object.entries(this.options||{}))c.set(o,s);if(c.printRoutes){console.log("JetPath: compiling paths..."),await m(this.options?.source),console.log("JetPath: done."),console.log(d);for(let o in l){let s=l[o];if(s&&Object.keys(s).length){console.log(`
`+o+": routes");for(let r in s)console.log("'"+r+"'")}}}else await m(this.options?.source);console.log(`
JetPath app listening on port ${e}...`),f.listen(this.options?.port||8080)}};export{_ as default};
