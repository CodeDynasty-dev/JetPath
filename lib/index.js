import{opendir as k}from"node:fs/promises";import{createServer as H}from"node:http";function C(t){let e={allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],origin:"*",secureContext:!1,keepHeadersOnError:!1,allowHeaders:[]};for(let s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.keepHeadersOnError=e.keepHeadersOnError===void 0||!!e.keepHeadersOnError,function(o){let r=e.credentials,n={};function i(p,c){o.set(p,c),n[p]=c}if(o.method!=="OPTIONS")i("Access-Control-Allow-Origin",e.origin),i("Vary","Origin"),r===!0&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&o.set("Access-Control-Allow-Headers",e.allowHeaders.join(","));else{if(!o.get("Access-Control-Request-Method"))return;o.set("Access-Control-Allow-Origin",e.origin),r===!0&&o.set("Access-Control-Allow-Credentials","true"),e.maxAge&&o.set("Access-Control-Max-Age",e.maxAge),e.privateNetworkAccess&&o.get("Access-Control-Request-Private-Network")&&o.set("Access-Control-Allow-Private-Network","true"),e.allowMethods&&o.set("Access-Control-Allow-Methods",e.allowMethods.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&o.set("Access-Control-Allow-Headers",e.allowHeaders.join(",")),o.statusCode=204}}}import{URLSearchParams as R}from"node:url";import A from"node:path";import{cwd as T}from"node:process";var P=t=>{try{return t(),!0}catch{return!1}},E=()=>{let t=P(()=>Bun),e=P(()=>Deno);return{bun:t,deno:e,node:!t&&!e}},h=E(),g={listen(t){}};h.node&&(g=H((t,e)=>{_(t,e)}));h.deno&&(g={listen(t){Deno.serve({port:t},_)}});h.bun&&(g={listen(t){Bun.serve({port:t,fetch:_})}});var d={GET:{},POST:{},HEAD:{},PUT:{},PATCH:{},DELETE:{},OPTIONS:{}},l={PRE:!1,POST:!1,ERROR:!1},y=class extends Error{constructor(e="done"){super(e)}},w=new y,a={cors:void 0,set(t,e){if(t==="cors"&&e){if(this.cors=C({exposeHeaders:"",allowMethods:"",allowHeaders:"",maxAge:"",keepHeadersOnError:!0,secureContext:!1,privateNetworkAccess:void 0,...typeof e=="object"?e:{}}),Array.isArray(e.allowMethods)){d={};for(let s of e.allowMethods)d[s.toUpperCase()]={}}return}this[t]=e}},b=t=>({request:t,body:null,app:{},statusCode:200,method:t.method,reply(e){let s;switch(typeof e){case"string":s="text/plain",this._1=e;break;case"object":s="application/json",this._1=JSON.stringify(e);break;default:s="text/plain",this._1=String(e);break}throw this._2["Content-Type"]=s,this._4=!0,w},redirect(e){throw this.statusCode=301,this._2.Location=e,this._1=void 0,this._4=!0,w},throw(e=404,s="Not Found"){if(!this._4)switch(this.statusCode=400,typeof e){case"number":this.statusCode=e,typeof s=="object"?(this._2["Content-Type"]="application/json",this._1=JSON.stringify(s)):typeof s=="string"&&(this._2["Content-Type"]="text/plain",this._1=s);break;case"string":this._2["Content-Type"]="text/plain",this._1=e;break;case"object":this._2["Content-Type"]="application/json",this._1=JSON.stringify(s);break}throw this._4=!0,w},get(e){if(e)return this.request.headers[e]},set(e,s){e&&s&&(this._2[e]=s)},pass(e,s){e&&s&&(this.app[e]=s)},pipe(e,s){this._2["Content-Disposition"]=s,this._3=e,this._4=!0},json(){return this.body?this.body:h.node?new Promise(e=>{let s="";this.request.on("data",o=>{s+=o.toString()}),this.request.on("end",()=>{try{this.body=JSON.parse(s)}catch{}e(this.body)})}):this.request.json()},text(){return this.body?this.body:h.node?new Promise(e=>{let s="";this.request.on("data",o=>{s+=o.toString()}),this.request.on("end",()=>{this.body=s,e(s)})}):this.request.text()},_1:void 0,_2:{},_3:void 0,_4:!1,params:{},search:{}}),f=(t,e)=>{if(!h.node)return e?.statusCode===301&&e._2.Location?Response.redirect(e._2.Location):new Response(e?._1||"Not found!",{status:e?.statusCode||404,headers:e?._2||{}});t.writeHead(e?.statusCode||404,e?._2||{"Content-Type":"text/plain"}),t.end(e?._1||"Not found!")},_=async(t,e)=>{let s={},o={},r=S(t.method,t.url);if(r){let n=b(t);r.length>1&&([r,s,o]=r,n.params=s,n.search=o);try{return l.PRE&&await l.PRE?.(n),await r(n),l.POST&&await l.POST(n),a.cors&&a.cors(n),!n._1&&n._3&&n._3.pipe(e),f(e,n)}catch(i){if(i instanceof y)return a.cors&&a.cors(n),f(e,n);try{return l.ERROR&&await l.ERROR(n,i),a.cors&&a.cors(n),f(e,n)}catch{return a.cors&&a.cors(n),f(e,n)}}}else{if(a.cors||t.method==="OPTIONS"){let n=b(t);return a.cors(n),f(e,n)}return f(e)}},x=t=>{if(t.includes("hook__"))return t.split("hook__")[1];t=t.split("_");let e=t.shift();if(t="/"+t.join("/"),t=t.split("$$"),t=t.join("/?"),t=t.split("$"),t=t.join("/:"),/(GET|POST|PUT|PATCH|DELETE|OPTIONS)/.test(e))return[e,t]};async function m(t,e){t=t||T(),t=A.resolve(T(),t),e&&console.log("JetPath: "+t);let s=await k(t);for await(let o of s){if(o.isFile()&&o.name.endsWith(".js")){let r=await import(A.resolve(t+"/"+o.name));for(let n in r){let i=x(n);i&&(typeof i!="string"&&d[i[0]]?d[i[0]][i[1]]=r[n]:l[i]===!1&&(l[i]=r[n]))}}o.isDirectory()&&o.name!=="node_modules"&&o.name!==".git"&&await m(t+"/"+o.name,e)}}var S=(t,e)=>{let s=d[t];if(e[0]!=="/"&&(e=e.slice(e.indexOf("/",7))),s[e])return s[e];if(typeof s=="function"){s();return}if(s[e+"/"])return s[e];if(e.includes("/?")){let o=[...new R(e).entries()],r={};for(let n in o)r[o[n][0].includes("?")?o[n][0].split("?")[1]:o[n][0]]=o[n][1];return[s[e.split("/?")[0]+"/?"],,r]}for(let o in s){if(!o.includes(":"))continue;let r=e.split("/"),n=o.split("/");e.endsWith("/")&&r.pop();let i=0,p=0;if(n.length===r.length){for(let c=0;c<n.length;c++){if(n[c].includes(":")){p++;continue}r[c]===n[c]&&i++}if(i+p===n.length){let c={};for(let u=0;u<n.length;u++)n[u].includes(":")&&(c[n[u].split(":")[1]]=r[u]);return[s[o],c]}}}};var O=class{constructor(e){this.options=e||{printRoutes:!0},this.server=g}async listen(){let e=this.options?.port||8080;for(let[s,o]of Object.entries(this.options||{}))a.set(s,o);if(a.printRoutes){console.log("JetPath: compiling paths..."),await m(this.options?.source,!0),console.log("JetPath: done."),console.log(l);for(let s in d){let o=d[s];if(o&&Object.keys(o).length){console.log(`
`+s+": routes");for(let r in o)console.log("'"+r+"'")}}}else await m(this.options?.source,!1);console.log(`
JetPath app listening on port ${e}...`),g.listen(this.options?.port||8080)}};export{O as JetPath};
