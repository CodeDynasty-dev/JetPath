import{opendir as O}from"node:fs/promises";import{URLSearchParams as k}from"node:url";import _ from"node:path";import{cwd as A}from"node:process";function T(t){let e={allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],origin:"*",secureContext:!1,keepHeadersOnError:!1,allowHeaders:[]};for(let s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.keepHeadersOnError=e.keepHeadersOnError===void 0||!!e.keepHeadersOnError,function(o){let r=e.credentials,n={};function i(p,l){o.set(p,l),n[p]=l}if(o.method!=="OPTIONS")i("Access-Control-Allow-Origin",e.origin),i("Vary","Origin"),r===!0&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&o.set("Access-Control-Allow-Headers",e.allowHeaders.join(","));else{if(!o.get("Access-Control-Request-Method"))return;o.set("Access-Control-Allow-Origin",e.origin),r===!0&&o.set("Access-Control-Allow-Credentials","true"),e.maxAge&&o.set("Access-Control-Max-Age",e.maxAge),e.privateNetworkAccess&&o.get("Access-Control-Request-Private-Network")&&o.set("Access-Control-Allow-Private-Network","true"),e.allowMethods&&o.set("Access-Control-Allow-Methods",e.allowMethods.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&o.set("Access-Control-Allow-Headers",e.allowHeaders.join(",")),o.code=204}}}var c={ae(t){try{return t(),!0}catch{return!1}},set(){let t=c.ae(()=>Bun),e=c.ae(()=>Deno);this.runtime={bun:t,deno:e,node:!t&&!e}},runtime:null,decorators:{},async server(){if(c.runtime.node){let{createServer:t}=await import("node:http");return t((e,s)=>{w(e,s)})}if(c.runtime.deno)return{listen(t){Deno.serve({port:t},w)}};if(c.runtime.bun)return{listen(t){Bun.serve({port:t,fetch:w})}}}};c.set();var f={GET:{},POST:{},HEAD:{},PUT:{},PATCH:{},DELETE:{},OPTIONS:{}},d={PRE:!1,POST:!1,ERROR:!1},u=class extends Error{constructor(e="done"){super(e)}},m=new u,a={cors:void 0,set(t,e){if(t==="cors"&&e){if(this.cors=T({exposeHeaders:"",allowMethods:"",allowHeaders:"",maxAge:"",keepHeadersOnError:!0,secureContext:!1,privateNetworkAccess:void 0,...typeof e=="object"?e:{}}),Array.isArray(e.allowMethods)){f={};for(let s of e.allowMethods)f[s.toUpperCase()]={}}return}this[t]=e}},P=(t,e={})=>({request:t,code:200,method:t.method,reply(s){let o;switch(typeof s){case"string":o="text/plain",this._1=s;break;case"object":o="application/json",this._1=JSON.stringify(s);break;default:o="text/plain",this._1=String(s);break}throw this._2||(this._2={},this._2["Content-Type"]=o),this._4=!0,m},redirect(s){throw this.code=301,this._2||(this._2={},this._2.Location=s),this._1=void 0,this._4=!0,m},throw(s=404,o="Not Found"){if(this._2||(this._2={}),!this._4)switch(this.code=400,typeof s){case"number":this.code=s,typeof o=="object"?(this._2["Content-Type"]="application/json",this._1=JSON.stringify(o)):typeof o=="string"&&(this._2["Content-Type"]="text/plain",this._1=o);break;case"string":this._2["Content-Type"]="text/plain",this._1=s;break;case"object":this._2["Content-Type"]="application/json",this._1=JSON.stringify(s);break}throw this._4=!0,m},get(s){if(s)return this.request.headers[s]},set(s,o){this._2||(this._2={}),s&&o&&(this._2[s]=o)},json(){return this.body?this.body:c.runtime.node?new Promise(s=>{let o="";this.request.on("data",r=>{o+=r.toString()}),this.request.on("end",()=>{try{this.body=JSON.parse(o)}catch{}s(this.body)})}):this.request.json()},...e}),h=(t,e)=>{if(!c.runtime.node)return e?.code===301&&e._2?.Location?Response.redirect(e._2?.Location):new Response(e?._1||"Not found!",{status:e?.code||404,headers:e?._2||{}});t.writeHead(e?.code||404,e?._2||{"Content-Type":"text/plain"}),t.end(e?._1||"Not found!")},w=async(t,e)=>{let s={},o={},r=b(t.method,t.url);if(r){let n=P(t,c.decorators);r.length>1&&([r,s,o]=r,n.params=s,n.search=o);try{return d.PRE&&await d.PRE?.(n),await r(n),d.POST&&await d.POST(n),a.cors&&a.cors(n),h(e,n)}catch(i){if(i instanceof u)return a.cors&&a.cors(n),h(e,n);try{return d.ERROR&&await d.ERROR(n,i),a.cors&&a.cors(n),h(e,n)}catch{return a.cors&&a.cors(n),h(e,n)}}}else{if(a.cors||t.method==="OPTIONS"){let n=P(t);return a.cors(n),h(e,n)}return h(e)}},R=t=>{if(t.includes("hook__"))return t.split("hook__")[1];t=t.split("_");let e=t.shift();if(t="/"+t.join("/"),t=t.split("$$"),t=t.join("/?"),t=t.split("$"),t=t.join("/:"),/(GET|POST|PUT|PATCH|DELETE|OPTIONS)/.test(e))return[e,t]};async function y(t,e){t=t||A(),t=_.resolve(A(),t),e&&console.log("JetPath: "+t);let s=await O(t);for await(let o of s){if(o.isFile()&&o.name.endsWith(".js")){let r=await import(_.resolve(t+"/"+o.name));for(let n in r){let i=R(n);if(i){if(typeof i!="string"&&f[i[0]])f[i[0]][i[1]]=r[n];else if(d[i]===!1)d[i]=r[n];else if(i==="DECORATOR"){let p=r[n]();typeof p=="object"&&(c.decorators=Object.assign(c.decorators,p))}}}}o.isDirectory()&&o.name!=="node_modules"&&o.name!==".git"&&await y(t+"/"+o.name,e)}}var b=(t,e)=>{let s=f[t];if(e[0]!=="/"&&(e=e.slice(e.indexOf("/",7))),s[e])return s[e];if(typeof s=="function"){s();return}if(s[e+"/"])return s[e];if(e.includes("/?")){let o=[...new k(e).entries()],r={};for(let n in o)r[o[n][0].includes("?")?o[n][0].split("?")[1]:o[n][0]]=o[n][1];return[s[e.split("/?")[0]+"/?"],,r]}for(let o in s){if(!o.includes(":"))continue;let r=e.split("/"),n=o.split("/");e.endsWith("/")&&r.pop();let i=0,p=0;if(n.length===r.length){for(let l=0;l<n.length;l++){if(n[l].includes(":")){p++;continue}r[l]===n[l]&&i++}if(i+p===n.length){let l={};for(let g=0;g<n.length;g++)n[g].includes(":")&&(l[n[g].split(":")[1]]=r[g]);return[s[o],l]}}}};var C=class{constructor(e){this.options=e||{printRoutes:!0},c.server().then(s=>{this.server=s})}async listen(){let e=this.options?.port||8080;for(let[s,o]of Object.entries(this.options||{}))a.set(s,o);if(a.printRoutes){console.log("JetPath: compiling..."),await y(this.options?.source,!0),console.log("JetPath: done."),console.log(d);for(let s in f){let o=f[s];if(o&&Object.keys(o).length){console.log(`
`+s+": routes");for(let r in o)console.log("'"+r+"'")}}}else await y(this.options?.source,!1);console.log(`
Listening on http://localhost:${e}/`),this.server.listen(this.options?.port||8080)}};export{C as JetPath};
