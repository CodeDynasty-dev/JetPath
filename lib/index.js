import{opendir as O}from"node:fs/promises";import{URLSearchParams as k}from"node:url";import _ from"node:path";import{cwd as A}from"node:process";function T(t){let e={allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],origin:"*",secureContext:!1,keepHeadersOnError:!1,allowHeaders:[]};for(let s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.keepHeadersOnError=e.keepHeadersOnError===void 0||!!e.keepHeadersOnError,function(o){let n=e.credentials,r={};function i(p,l){o.set(p,l),r[p]=l}if(o.method!=="OPTIONS")i("Access-Control-Allow-Origin",e.origin),i("Vary","Origin"),n===!0&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&o.set("Access-Control-Allow-Headers",e.allowHeaders.join(","));else{if(!o.get("Access-Control-Request-Method"))return;o.set("Access-Control-Allow-Origin",e.origin),n===!0&&o.set("Access-Control-Allow-Credentials","true"),e.maxAge&&o.set("Access-Control-Max-Age",e.maxAge),e.privateNetworkAccess&&o.get("Access-Control-Request-Private-Network")&&o.set("Access-Control-Allow-Private-Network","true"),e.allowMethods&&o.set("Access-Control-Allow-Methods",e.allowMethods.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&o.set("Access-Control-Allow-Headers",e.allowHeaders.join(",")),o.code=204}}}import{createServer as b}from"node:http";var a={ae(t){try{return t(),!0}catch{return!1}},set(){let t=a.ae(()=>Bun),e=a.ae(()=>Deno);this.runtime={bun:t,deno:e,node:!t&&!e}},runtime:null,decorators:{},server(){if(a.runtime.node)return b((t,e)=>{w(t,e)});if(a.runtime.deno)return{listen(t){Deno.serve({port:t},w)}};if(a.runtime.bun)return{listen(t){Bun.serve({port:t,fetch:w})}}}};a.set();var f={GET:{},POST:{},HEAD:{},PUT:{},PATCH:{},DELETE:{},OPTIONS:{}},d={PRE:!1,POST:!1,ERROR:!1},u=class extends Error{constructor(e="done"){super(e)}},y=new u,c={cors:void 0,set(t,e){if(t==="cors"&&e){if(this.cors=T({exposeHeaders:"",allowMethods:"",allowHeaders:"",maxAge:"",keepHeadersOnError:!0,secureContext:!1,privateNetworkAccess:void 0,...typeof e=="object"?e:{}}),Array.isArray(e.allowMethods)){f={};for(let s of e.allowMethods)f[s.toUpperCase()]={}}return}this[t]=e}},C=(t,e={})=>({request:t,code:200,method:t.method,reply(s){let o;switch(typeof s){case"string":o="text/plain",this._1=s;break;case"object":o="application/json",this._1=JSON.stringify(s);break;default:o="text/plain",this._1=String(s);break}throw this._2||(this._2={},this._2["Content-Type"]=o),this._4=!0,y},redirect(s){throw this.code=301,this._2||(this._2={},this._2.Location=s),this._1=void 0,this._4=!0,y},throw(s=404,o="Not Found"){if(this._2||(this._2={}),!this._4)switch(this.code=400,typeof s){case"number":this.code=s,typeof o=="object"?(this._2["Content-Type"]="application/json",this._1=JSON.stringify(o)):typeof o=="string"&&(this._2["Content-Type"]="text/plain",this._1=o);break;case"string":this._2["Content-Type"]="text/plain",this._1=s;break;case"object":this._2["Content-Type"]="application/json",this._1=JSON.stringify(s);break}throw this._4=!0,y},get(s){if(s)return this.request.headers[s]},set(s,o){this._2||(this._2={}),s&&o&&(this._2[s]=o)},json(){return this.body?this.body:a.runtime.node?new Promise(s=>{let o="";this.request.on("data",n=>{o+=n.toString()}),this.request.on("end",()=>{try{this.body=JSON.parse(o)}catch{}s(this.body)})}):this.request.json()},...e}),h=(t,e)=>{if(!a.runtime.node)return e?.code===301&&e._2?.Location?Response.redirect(e._2?.Location):new Response(e?._1||"Not found!",{status:e?.code||404,headers:e?._2||{}});t.writeHead(e?.code||404,e?._2||{"Content-Type":"text/plain"}),t.end(e?._1||"Not found!")},w=async(t,e)=>{let s={},o={},n=H(t.method,t.url);if(n){let r=C(t,a.decorators);n.length>1&&([n,s,o]=n,r.params=s,r.search=o);try{return d.PRE&&await d.PRE?.(r),await n(r),d.POST&&await d.POST(r),c.cors&&c.cors(r),h(e,r)}catch(i){if(i instanceof u)return c.cors&&c.cors(r),h(e,r);try{return d.ERROR&&await d.ERROR(r,i),c.cors&&c.cors(r),h(e,r)}catch{return c.cors&&c.cors(r),h(e,r)}}}else{if(c.cors||t.method==="OPTIONS"){let r=C(t);return c.cors(r),h(e,r)}return h(e)}},R=t=>{if(t.includes("hook__"))return t.split("hook__")[1];t=t.split("_");let e=t.shift();if(t="/"+t.join("/"),t=t.split("$$"),t=t.join("/?"),t=t.split("$"),t=t.join("/:"),/(GET|POST|PUT|PATCH|DELETE|OPTIONS)/.test(e))return[e,t]};async function m(t,e){t=t||A(),t=_.resolve(A(),t),e&&console.log("JetPath: "+t);let s=await O(t);for await(let o of s){if(o.isFile()&&o.name.endsWith(".js")){let n=await import(_.resolve(t+"/"+o.name));for(let r in n){let i=R(r);if(i){if(typeof i!="string"&&f[i[0]])f[i[0]][i[1]]=n[r];else if(d[i]===!1)d[i]=n[r];else if(i==="DECORATOR"){let p=n[r]();typeof p=="object"&&(a.decorators=Object.assign(a.decorators,p))}}}}o.isDirectory()&&o.name!=="node_modules"&&o.name!==".git"&&await m(t+"/"+o.name,e)}}var H=(t,e)=>{let s=f[t];if(e[0]!=="/"&&(e=e.slice(e.indexOf("/",7))),s[e])return s[e];if(typeof s=="function"){s();return}if(s[e+"/"])return s[e];if(e.includes("/?")){let o=[...new k(e).entries()],n={};for(let r in o)n[o[r][0].includes("?")?o[r][0].split("?")[1]:o[r][0]]=o[r][1];return[s[e.split("/?")[0]+"/?"],,n]}for(let o in s){if(!o.includes(":"))continue;let n=e.split("/"),r=o.split("/");e.endsWith("/")&&n.pop();let i=0,p=0;if(r.length===n.length){for(let l=0;l<r.length;l++){if(r[l].includes(":")){p++;continue}n[l]===r[l]&&i++}if(i+p===r.length){let l={};for(let g=0;g<r.length;g++)r[g].includes(":")&&(l[r[g].split(":")[1]]=n[g]);return[s[o],l]}}}};var P=class{constructor(e){this.options=e||{printRoutes:!0},this.server=a.server()}async listen(){let e=this.options?.port||8080;for(let[s,o]of Object.entries(this.options||{}))c.set(s,o);if(typeof this.options!="object"||this.options.printRoutes!==!1){console.log("JetPath: compiling..."),await m(this.options?.source,!0),console.log("JetPath: done."),console.log(d);for(let s in f){let o=f[s];if(o&&Object.keys(o).length){console.log(`
`+s+": routes");for(let n in o)console.log("'"+n+"'")}}}else await m(this.options?.source,!1);console.log(`
Listening on http://localhost:${e}/`),this.server.listen(this.options?.port||8080)}};export{P as JetPath};
