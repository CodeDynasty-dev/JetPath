import{opendir as P}from"node:fs/promises";import{URLSearchParams as O}from"node:url";import _ from"node:path";import{cwd as T}from"node:process";import{createServer as k}from"node:http";function b(t){let e={allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],origin:"*",secureContext:!1,keepHeadersOnError:!1,allowHeaders:[]};for(let o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);return Array.isArray(e.allowMethods)&&(e.allowMethods=e.allowMethods.join(",")),e.maxAge&&(e.maxAge=String(e.maxAge)),e.keepHeadersOnError=e.keepHeadersOnError===void 0||!!e.keepHeadersOnError,function(s){let r=e.credentials,n={};function i(p,l){s.set(p,l),n[p]=l}if(s.method!=="OPTIONS")i("Access-Control-Allow-Origin",e.origin),i("Vary","Origin"),r===!0&&i("Access-Control-Allow-Credentials","true"),e.exposeHeaders&&i("Access-Control-Expose-Headers",e.exposeHeaders.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&s.set("Access-Control-Allow-Headers",e.allowHeaders.join(","));else{if(!s.get("Access-Control-Request-Method"))return;s.set("Access-Control-Allow-Origin",e.origin),r===!0&&s.set("Access-Control-Allow-Credentials","true"),e.maxAge&&s.set("Access-Control-Max-Age",e.maxAge),e.privateNetworkAccess&&s.get("Access-Control-Request-Private-Network")&&s.set("Access-Control-Allow-Private-Network","true"),e.allowMethods&&s.set("Access-Control-Allow-Methods",e.allowMethods.join(",")),e.secureContext&&(i("Cross-Origin-Opener-Policy","same-origin"),i("Cross-Origin-Embedder-Policy","require-corp")),e.allowHeaders&&s.set("Access-Control-Allow-Headers",e.allowHeaders.join(",")),s.code=204}}}var a={ae(t){try{return t(),!0}catch{return!1}},set(){let t=a.ae(()=>Bun),e=a.ae(()=>Deno);this.runtime={bun:t,deno:e,node:!t&&!e}},runtime:null,decorators:{},server(){if(a.runtime.node)return k((t,e)=>{w(t,e)});if(a.runtime.deno)return{listen(t){Deno.serve({port:t},w)}};if(a.runtime.bun)return{listen(t){Bun.serve({port:t,fetch:w})}}}};a.set();var f={GET:{},POST:{},HEAD:{},PUT:{},PATCH:{},DELETE:{},OPTIONS:{}},d={PRE:!1,POST:!1,ERROR:!1},m=class extends Error{constructor(e="done"){super(e)}},g=new m,c={cors:void 0,set(t,e){if(t==="cors"&&e){if(this.cors=b({exposeHeaders:"",allowMethods:"",allowHeaders:"",maxAge:"",keepHeadersOnError:!0,secureContext:!1,privateNetworkAccess:void 0,...typeof e=="object"?e:{}}),Array.isArray(e.allowMethods)){f={};for(let o of e.allowMethods)f[o.toUpperCase()]={}}return}this[t]=e}},A=(t,e={})=>({request:t,code:200,method:t.method,reply(o,s){let r;switch(typeof o){case"string":r="text/plain",this._1=o;break;case"object":r="application/json",this._1=JSON.stringify(o);break;default:r="text/plain",this._1=String(o);break}throw s&&(r=s),this._2||(this._2={}),this._2["Content-Type"]=r,this._4=!0,g},redirect(o){throw this.code=301,this._2||(this._2={},this._2.Location=o),this._1=void 0,this._4=!0,g},throw(o=404,s="Not Found"){if(this._2||(this._2={}),!this._4)switch(this.code=400,typeof o){case"number":this.code=o,typeof s=="object"?(this._2["Content-Type"]="application/json",this._1=JSON.stringify(s)):typeof s=="string"&&(this._2["Content-Type"]="text/plain",this._1=s);break;case"string":this._2["Content-Type"]="text/plain",this._1=o;break;case"object":this._2["Content-Type"]="application/json",this._1=JSON.stringify(o);break}throw this._4=!0,g},get(o){if(o)return this.request.headers[o]},set(o,s){this._2||(this._2={}),o&&s&&(this._2[o]=s)},pipe(o,s,r){if(this._2||(this._2={}),this._2["Content-Disposition"]=`inline;filename="${r||"unnamed.bin"}"`,this._2["Content-Type"]=s,!a.runtime.node)return this.reply(o,s);throw this._3=o,this._4=!0,g},json(){return this.body?this.body:a.runtime.node?new Promise(o=>{let s="";this.request.on("data",r=>{s+=r.toString()}),this.request.on("end",()=>{try{this.body=JSON.parse(s)}catch{}o(this.body)})}):this.request.json()},...e}),h=(t,e)=>{if(!a.runtime.node)return e?.code===301&&e._2?.Location?Response.redirect(e._2?.Location):new Response(e?._1||"Not found!",{status:e?.code||404,headers:e?._2||{}});if(e?._3){t.setHeader("Content-Type",(e?._2||{})["Content-Type"]||"text/plain"),e._3.pipe(t);return}t.writeHead(e?.code||404,e?._2||{"Content-Type":"text/plain"}),t.end(e?._1||"Not found!")},w=async(t,e)=>{let o={},s={},r=H(t.method,t.url);if(r){let n=A(t,a.decorators);r.length>1&&([r,o,s]=r,n.params=o,n.search=s);try{return d.PRE&&await d.PRE?.(n),await r(n),d.POST&&await d.POST(n),c.cors&&c.cors(n),h(e,n)}catch(i){if(i instanceof m)return c.cors&&c.cors(n),h(e,n);try{return d.ERROR&&await d.ERROR(n,i),c.cors&&c.cors(n),h(e,n)}catch{return c.cors&&c.cors(n),h(e,n)}}}else{if(c.cors||t.method==="OPTIONS"){let n=A(t);return c.cors(n),h(e,n)}return h(e)}},R=t=>{if(t.includes("hook__"))return t.split("hook__")[1];t=t.split("_");let e=t.shift();if(t="/"+t.join("/"),t=t.split("$$"),t=t.join("/?"),t=t.split("$0"),t=t.join("/*"),t=t.split("$"),t=t.join("/:"),/(GET|POST|PUT|PATCH|DELETE|OPTIONS)/.test(e))return[e,t]};async function y(t,e){t=t||T(),t=_.resolve(T(),t),e&&console.log("JetPath: "+t);let o=await P(t);for await(let s of o){if(s.isFile()&&s.name.endsWith(".js")){let r=await import(_.resolve(t+"/"+s.name));for(let n in r){let i=R(n);if(i){if(typeof i!="string"&&f[i[0]])f[i[0]][i[1]]=r[n];else if(d[i]===!1)d[i]=r[n];else if(i==="DECORATOR"){let p=r[n]();typeof p=="object"&&(a.decorators=Object.assign(a.decorators,p))}}}}s.isDirectory()&&s.name!=="node_modules"&&s.name!==".git"&&await y(t+"/"+s.name,e)}}var H=(t,e)=>{let o=f[t];if(e[0]!=="/"&&(e=e.slice(e.indexOf("/",7))),o[e])return o[e];if(typeof o=="function"){o();return}if(o[e+"/"])return o[e];if(e.includes("/?")){let s=[...new O(e).entries()],r={};for(let n in s)r[s[n][0].includes("?")?s[n][0].split("?")[1]:s[n][0]]=s[n][1];return[o[e.split("/?")[0]+"/?"],,r]}for(let s in o){if(s.includes(":")){let r=e.split("/"),n=s.split("/");e.endsWith("/")&&r.pop();let i=0,p=0;if(n.length===r.length){for(let l=0;l<n.length;l++){if(n[l].includes(":")){p++;continue}r[l]===n[l]&&i++}if(i+p===n.length){let l={};for(let u=0;u<n.length;u++)n[u].includes(":")&&(l[n[u].split(":")[1]]=r[u]);return[o[s],l]}}}if(s.includes("*")){let r=s.slice(0,-1);if(e.startsWith(r))return[o[s],{extraPath:e.slice(r.length)}]}}};var C=class{constructor(e){this.options=e||{printRoutes:!0},this.server=a.server()}async listen(){let e=this.options?.port||8080;for(let[o,s]of Object.entries(this.options||{}))c.set(o,s);if(typeof this.options!="object"||this.options.printRoutes!==!1){console.log("JetPath: compiling..."),await y(this.options?.source,!0),console.log("JetPath: done."),console.log(d);for(let o in f){let s=f[o];if(s&&Object.keys(s).length){console.log(`
`+o+": routes");for(let r in s)console.log("'"+r+"'")}}}else await y(this.options?.source,!1);console.log(`
Listening on http://localhost:${e}/`),this.server.listen(this.options?.port||8080)}};export{C as JetPath};
